name: Test

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip all tests (emergency override)'
        required: false
        type: boolean
        default: false
      run_coverage:
        description: 'Run code coverage'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  pull-requests: write
  checks: write

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-config:
    runs-on: ubuntu-latest
    outputs:
      tests_enabled: ${{ steps.config.outputs.tests_enabled }}
      skip_reason: ${{ steps.config.outputs.skip_reason }}

    steps:
      - name: Check if tests should run
        id: config
        env:
          # Repository variable to globally disable tests
          DISABLE_TESTS: ${{ vars.DISABLE_TESTS }}
        run: |
          # Check manual override (workflow_dispatch)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.skip_tests }}" = "true" ]; then
            echo "tests_enabled=false" >> $GITHUB_OUTPUT
            echo "skip_reason=Manual override: Tests skipped via workflow dispatch" >> $GITHUB_OUTPUT
            echo "â­ï¸ Tests disabled: Manual workflow dispatch override"
            exit 0
          fi

          # Check repository variable
          if [ "$DISABLE_TESTS" = "true" ]; then
            echo "tests_enabled=false" >> $GITHUB_OUTPUT
            echo "skip_reason=Tests disabled via repository variable DISABLE_TESTS" >> $GITHUB_OUTPUT
            echo "â­ï¸ Tests disabled: Repository variable DISABLE_TESTS=true"
            exit 0
          fi

          # Check for commit message override
          if echo "${{ github.event.head_commit.message }}" | grep -qE "\[skip tests\]|\[no tests\]"; then
            echo "tests_enabled=false" >> $GITHUB_OUTPUT
            echo "skip_reason=Tests skipped via commit message [skip tests]" >> $GITHUB_OUTPUT
            echo "â­ï¸ Tests disabled: Commit message contains [skip tests]"
            exit 0
          fi

          # Tests are enabled
          echo "tests_enabled=true" >> $GITHUB_OUTPUT
          echo "skip_reason=" >> $GITHUB_OUTPUT
          echo "âœ… Tests enabled"

  check-changes:
    needs: check-config
    if: needs.check-config.outputs.tests_enabled == 'true'
    runs-on: ubuntu-latest
    outputs:
      has_rust_changes: ${{ steps.rust_changes.outputs.has_changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Rust file changes
        id: rust_changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, check changes between base and head
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '\.rs$' || true)
          else
            # For pushes, check changes in the commit
            if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
              # New branch, check all .rs files
              CHANGED_FILES=$(find . -name "*.rs" -type f | wc -l)
              if [ "$CHANGED_FILES" -gt 0 ]; then
                CHANGED_FILES="found"
              fi
            else
              # Check changes in the push
              CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '\.rs$' || true)
            fi
          fi

          if [ -n "$CHANGED_FILES" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Rust files changed - will run tests"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No Rust files changed - skipping tests"
          fi

  test:
    needs: [check-config, check-changes]
    if: |
      needs.check-config.outputs.tests_enabled == 'true' &&
      needs.check-changes.outputs.has_rust_changes == 'true'
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable, beta]
        exclude:
          # Skip beta on macOS and Windows to save CI time
          - os: macos-latest
            rust: beta
          - os: windows-latest
            rust: beta

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust ${{ matrix.rust }}
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.rust }}-
            ${{ runner.os }}-cargo-

      - name: Check formatting
        if: matrix.rust == 'stable' && matrix.os == 'ubuntu-latest'
        run: cargo fmt -- --check

      - name: Run clippy
        if: matrix.rust == 'stable'
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build
        run: cargo build --verbose

      - name: Run unit tests
        run: cargo test --lib --verbose

      - name: Run integration tests
        run: cargo test --test integration_test --verbose

      - name: Run doc tests
        run: cargo test --doc --verbose

      - name: Run tests with all features
        run: cargo test --all-features --verbose

  coverage:
    needs: [check-config, check-changes]
    if: |
      needs.check-config.outputs.tests_enabled == 'true' &&
      needs.check-changes.outputs.has_rust_changes == 'true' &&
      (github.event_name != 'workflow_dispatch' || inputs.run_coverage == true)
    runs-on: ubuntu-latest
    outputs:
      lines_percent: ${{ steps.coverage.outputs.lines_percent }}
      lines_covered: ${{ steps.coverage.outputs.lines_covered }}
      lines_total: ${{ steps.coverage.outputs.lines_total }}
      branches_percent: ${{ steps.coverage.outputs.branches_percent }}
      branches_covered: ${{ steps.coverage.outputs.branches_covered }}
      branches_total: ${{ steps.coverage.outputs.branches_total }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Generate code coverage
        run: |
          cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info
          cargo llvm-cov --all-features --workspace --json --output-path coverage.json

      - name: Parse coverage stats
        id: coverage
        run: |
          # Parse coverage from JSON output
          if [ -f coverage.json ]; then
            lines_covered=$(jq '.data[0].totals.lines.covered' coverage.json)
            lines_total=$(jq '.data[0].totals.lines.count' coverage.json)
            lines_percent=$(jq '.data[0].totals.lines.percent' coverage.json)

            branches_covered=$(jq '.data[0].totals.branches.covered' coverage.json)
            branches_total=$(jq '.data[0].totals.branches.count' coverage.json)
            branches_percent=$(jq '.data[0].totals.branches.percent' coverage.json)

            echo "lines_covered=$lines_covered" >> $GITHUB_OUTPUT
            echo "lines_total=$lines_total" >> $GITHUB_OUTPUT
            echo "lines_percent=$lines_percent" >> $GITHUB_OUTPUT
            echo "branches_covered=$branches_covered" >> $GITHUB_OUTPUT
            echo "branches_total=$branches_total" >> $GITHUB_OUTPUT
            echo "branches_percent=$branches_percent" >> $GITHUB_OUTPUT

            echo "ğŸ“Š Coverage: Lines: $lines_percent% ($lines_covered/$lines_total), Branches: $branches_percent% ($branches_covered/$branches_total)"
          fi

      - name: Upload coverage files
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            lcov.info
            coverage.json
            target/llvm-cov/html/
          retention-days: 30

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  test-summary:
    needs: [check-config, check-changes, test, coverage]
    if: always()
    runs-on: ubuntu-latest
    # This job is required for branch protection rules
    # Always runs to report status even if tests are skipped

    steps:
      - name: Determine overall status
        id: status
        run: |
          # Check if tests were disabled
          if [ "${{ needs.check-config.outputs.tests_enabled }}" != "true" ]; then
            echo "result=disabled" >> $GITHUB_OUTPUT
            echo "message=âš ï¸ Tests disabled: ${{ needs.check-config.outputs.skip_reason }}" >> $GITHUB_OUTPUT
          elif [ "${{ needs.check-changes.outputs.has_rust_changes }}" != "true" ]; then
            echo "result=skipped" >> $GITHUB_OUTPUT
            echo "message=â­ï¸ Tests skipped - no Rust file changes detected" >> $GITHUB_OUTPUT
          elif [ "${{ needs.test.result }}" = "success" ]; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "message=âœ… All tests passed successfully!" >> $GITHUB_OUTPUT
          elif [ "${{ needs.test.result }}" = "failure" ]; then
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ Tests failed" >> $GITHUB_OUTPUT
          elif [ "${{ needs.test.result }}" = "cancelled" ]; then
            echo "result=cancelled" >> $GITHUB_OUTPUT
            echo "message=âš ï¸ Tests were cancelled" >> $GITHUB_OUTPUT
          else
            echo "result=unknown" >> $GITHUB_OUTPUT
            echo "message=âš ï¸ Tests status: ${{ needs.test.result }}" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.status.outputs.result }}';
            const message = '${{ steps.status.outputs.message }}';

            // Get test results details
            const testResults = {
              hasChanges: '${{ needs.check-changes.outputs.has_rust_changes }}',
              testResult: '${{ needs.test.result }}',
              coverageResult: '${{ needs.coverage.result }}'
            };

            // Get coverage stats
            const coverage = {
              linesPercent: '${{ needs.coverage.outputs.lines_percent }}',
              linesCovered: '${{ needs.coverage.outputs.lines_covered }}',
              linesTotal: '${{ needs.coverage.outputs.lines_total }}',
              branchesPercent: '${{ needs.coverage.outputs.branches_percent }}',
              branchesCovered: '${{ needs.coverage.outputs.branches_covered }}',
              branchesTotal: '${{ needs.coverage.outputs.branches_total }}'
            };

            // Build comment body
            let body = '## ğŸ§ª Test Results\n\n';

            if (status === 'disabled') {
              body += 'âš ï¸ **Tests Disabled**\n\n';
              body += message + '\n\n';
              body += '**To re-enable tests:**\n';
              body += '- Remove `[skip tests]` from commit messages\n';
              body += '- Set repository variable `DISABLE_TESTS` to `false` (if set)\n';
              body += '- Use workflow dispatch without "Skip all tests" option\n';
            } else if (status === 'skipped') {
              body += 'â­ï¸ **Tests Skipped**\n\n';
              body += 'No Rust file changes detected in this PR.\n';
            } else if (status === 'success') {
              body += 'âœ… **All Tests Passed**\n\n';
              body += '| Check | Status |\n';
              body += '|-------|--------|\n';
              body += '| Code Formatting | âœ… Passed |\n';
              body += '| Clippy Lints | âœ… Passed |\n';
              body += '| Unit Tests | âœ… Passed |\n';
              body += '| Integration Tests | âœ… Passed |\n';
              body += '| Doc Tests | âœ… Passed |\n';
              if (testResults.coverageResult === 'success') {
                body += '| Code Coverage | âœ… Generated |\n';
              }
              body += '\n**Tested on:** Ubuntu (stable, beta), macOS (stable), Windows (stable)\n';

              // Add coverage section if available
              if (testResults.coverageResult === 'success' && coverage.linesPercent) {
                body += '\n### ğŸ“Š Code Coverage\n\n';
                body += '| Type | Coverage | Covered/Total |\n';
                body += '|------|----------|---------------|\n';

                const linesIcon = parseFloat(coverage.linesPercent) >= 80 ? 'âœ…' :
                                  parseFloat(coverage.linesPercent) >= 60 ? 'âš ï¸' : 'âŒ';
                const branchesIcon = parseFloat(coverage.branchesPercent) >= 80 ? 'âœ…' :
                                     parseFloat(coverage.branchesPercent) >= 60 ? 'âš ï¸' : 'âŒ';

                body += `| Lines ${linesIcon} | ${parseFloat(coverage.linesPercent).toFixed(2)}% | ${coverage.linesCovered}/${coverage.linesTotal} |\n`;
                body += `| Branches ${branchesIcon} | ${parseFloat(coverage.branchesPercent).toFixed(2)}% | ${coverage.branchesCovered}/${coverage.branchesTotal} |\n`;

                body += '\nğŸ’¡ **Coverage Thresholds:** âœ… â‰¥80% | âš ï¸ â‰¥60% | âŒ <60%\n';
                body += `\n[View detailed coverage report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)\n`;
              }
            } else if (status === 'failure') {
              body += 'âŒ **Tests Failed**\n\n';
              body += 'Some tests did not pass. Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.\n\n';
              body += '**Common fixes:**\n';
              body += '- Run `cargo fmt` to fix formatting issues\n';
              body += '- Run `cargo clippy --fix` to fix linting issues\n';
              body += '- Run `cargo test` locally to reproduce failures\n';
            } else if (status === 'cancelled') {
              body += 'âš ï¸ **Tests Cancelled**\n\n';
              body += 'The test workflow was cancelled.\n';
            } else {
              body += `âš ï¸ **Unknown Status**\n\nTests status: ${testResults.testResult}\n`;
            }

            body += `\n---\n*Workflow: [${context.workflow}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## ğŸ§ª Test Results')
            );

            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Test Summary
        run: |
          echo "${{ steps.status.outputs.message }}"
          if [ "${{ steps.status.outputs.result }}" = "failure" ] || [ "${{ steps.status.outputs.result }}" = "cancelled" ]; then
            exit 1
          fi
